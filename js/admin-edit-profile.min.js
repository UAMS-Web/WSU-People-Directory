var wsuwp=wsuwp||{};!function(e,t,o,s){e(o).ready(function(){var a,n,i=e("#load-ad-data"),r=e("#publishing-action .spinner"),l=e("#_wsuwp_profile_ad_nid"),p=e("#confirm-ad-hash"),d=e("#confirm-ad-data"),u=e(".wsu-person .card"),c=e(".wsu-person-photo-collection"),f=_.template(e(".wsu-person-repeatable-meta-template").html()),h=_.template(e(".wsu-person-photo-template").html());e(".card header").append("<button type='button' data-type='degree' class='wsu-person-add-repeatable-meta wsu-person-add-degree'>+ Add</button>"),e(".contact .title").last().after("\n<button type='button' data-type='title' class='wsu-person-add-repeatable-meta wsu-person-add-title'>+ Add another title</button>"),e.each(e(".contact .title").slice(1),function(){e(this).after("<button type='button' class='wsu-person-remove dashicons dashicons-no'><span class='screen-reader-text'>Delete</span></button>")}),e.each(e("header .degree"),function(){e(this).after("<button type='button' class='wsu-person-remove dashicons dashicons-no'><span class='screen-reader-text'>Delete</span></button>")}),i.on("click",function(o){if(o.preventDefault(),o.target.disabled=!0,""!==l.val()){r.css("visibility","visible");var a={action:"wsu_people_get_data_by_nid",_ajax_nonce:t.wsuwp_people_edit_profile.nid_nonce,network_id:l.val(),request_from:t.wsuwp_people_edit_profile.request_from,is_refresh:e(o.target).is("#refresh-ad-data")?"true":"false"};e.post(t.ajaxurl,a,function(a){o.target.disabled=!1,r.css("visibility","hidden"),a.success?e.isEmptyObject(a.data)?t.alert("Sorry, a profile for "+l.val()+" could not be found."):(a.data.id?s.people.populate_person_from_people_directory(a.data):(e(".wsu-person").attr("data-nid",l.val()),e(".wsu-person .name").text(a.data.given_name+" "+a.data.surname),e("[name='post_title']").val(a.data.given_name+" "+a.data.surname),e(".wsu-person .title").text(a.data.title),e("[name='_wsuwp_profile_title[]']").val(a.data.title),e(".wsu-person .email").text(a.data.email),e("[name='_wsuwp_profile_alt_email']").val(a.data.email),e(".wsu-person .phone").text(a.data.telephone_number),e("[name='_wsuwp_profile_alt_phone']").val(a.data.telephone_number),e(".wsu-person .office").text(a.data.office),e("[name='_wsuwp_profile_alt_office']").val(a.data.office),e(".wsu-person .address").text(a.data.street_address),e("[name='_wsuwp_profile_alt_address']").val(a.data.street_address),p.val(a.data.confirm_ad_hash)),e("#wsuwp-university-taxonomies").addClass("show"),e("#wsuwp-profile-listing").addClass("show"),d.removeClass("profile-hide-button")):t.alert(a.data)})}else t.alert("Please enter a Network ID")}),d.on("click",function(o){o.preventDefault(),o.target.disabled=!0,r.css("visibility","visible"),e("#load-ad-data").addClass("profile-hide-button");var s={action:"wsu_people_confirm_nid_data",_ajax_nonce:t.wsuwp_people_edit_profile.nid_nonce,network_id:l.val(),confirm_ad_hash:p.val(),post_id:e("#post_ID").val(),request_from:t.wsuwp_people_edit_profile.request_from},a=e(".load-ad-container .description"),n=e("#publish");e.post(t.ajaxurl,s,function(t){t.success&&(l.attr("readonly",!0),a.html("The WSU Network ID used to populate this profile's data from "+a.data("location")+"."),e(".spinner").css("visibility","hidden"),d.addClass("profile-hide-button"),n.removeClass("profile-hide-button"))})}),u.on("focusout","[contenteditable='true']",function(){var t=e(this).attr("class"),o=e(this).index("."+t),s=e(this).text();e("[data-for='"+t+"']").eq(o).val(s)}),u.on("keypress","[contenteditable='true']",function(e){13===e.which&&e.preventDefault()}),u.on("click",".wsu-person-add-repeatable-meta",function(){e(this).before(f({type:e(this).data("type"),value:""}))}),u.on("focus",".title, .degree",function(){e(this).next("button:not(.wsu-person-add-repeatable-meta)").show(50)}),u.on("focusout",".title, .degree, .wsu-person-remove",function(t){var o=e(t.relatedTarget);if(!o.hasClass("wsu-person-remove"))if(o.hasClass("title")||o.hasClass("title")){var s=o.next(".wsu-person-remove").index(".wsu-person-remove");e(".wsu-person-remove").not(":eq("+s+")").hide(50)}else e(".wsu-person-remove").hide(50)}),u.on("click",".wsu-person-remove",function(){var t=e(this).prev("span"),o=t.attr("class"),s=t.index("."+o);t.remove(),e("[data-for='"+o+"']").eq(s).remove(),e(this).remove()}),u.on("click",".photo",function(){if(!e(this).hasClass("wsu-person-add-photo")){var t=e(this).offset();a=o.activeElement,e("body").addClass("wsu-person-photo-collection-open"),c.css({top:t.top,left:t.left}),e(".wsu-person-add-photo").focus()}}),e(o).keydown(function(t){if(e("body").hasClass("wsu-person-photo-collection-open")){if(9===t.which){var o=c.find("button"),s=o.index(e(":focus"));t.shiftKey&&0===s?(o[o.length-1].focus(),t.preventDefault()):event.shiftKey||s!==o.length-1||(o[0].focus(),t.preventDefault())}27===t.which&&(e("body").removeClass("wsu-person-photo-collection-open"),a.focus())}}),e(o).on("click",".wsu-person-photo-collection-close",function(t){t.target===this&&(e("body").removeClass("wsu-person-photo-collection-open"),a.focus())}),e(o).on("click",".wsu-person-add-photo",function(){n?n.open():((n=t.wp.media({title:"Select or Upload Your Photos",multiple:!0,library:{type:"image",uploadedTo:t.wsuwp_people_edit_profile.post_id},button:{text:"Use photo(s)"}})).on("select",function(){var o=n.state().get("selection");e.each(o.models,function(o,a){var n=a.toJSON(),i=n.sizes.hasOwnProperty("thumbnail")?n.sizes.thumbnail.url:n.url,r=!1;-1===e.inArray(n.id,s.existing_photos())?(e("button.wsu-person-add-photo").before(h({src:i,id:n.id})),!r&&e(".photo").hasClass("wsu-person-add-photo")&&(e(".photo").removeClass("wsu-person-add-photo").prepend("<img src='"+i+"'>"),e(".photo figcaption").text("Manage photo collection"),r=!0)):t.alert(n.url+" is already in your collection.")})}),n.open())}),c.on("click",".wsu-person-remove",function(){e(this).parent(".wsu-person-photo-wrapper").remove()})}),e(".taxonomy-select2").select2({placeholder:"+ Add",closeOnSelect:!1,templateResult:function(t,o){return t.element&&e(o).addClass(e(t.element).attr("class")),t.text}}),s.existing_photos=function(){return e("[name='_wsuwp_profile_photos[]']").map(function(){return parseInt(e(this).val())}).get()}}(jQuery,window,document,wsuwp);