var wsuwp=wsuwp||{};!function(e,t,o,a){e(o).ready(function(){var s,n=e("#load-ad-data"),r=e("#publishing-action .spinner"),i=e("#_wsuwp_profile_ad_nid"),l=e("#confirm-ad-hash"),p=e("#confirm-ad-data"),d=e(".wsu-person .card"),u=e(".wsu-person-photo-collection"),c=_.template(e(".wsu-person-repeatable-meta-template").html()),f=_.template(e(".wsu-person-photo-template").html());e(".card header").append("<button type='button' data-type='degree' class='wsu-person-add-repeatable-meta wsu-person-add-degree'>+ Add</button>"),e(".contact .title").last().after("\n<button type='button' data-type='title' class='wsu-person-add-repeatable-meta wsu-person-add-title'>+ Add another title</button>"),e.each(e(".contact .title").slice(1),function(){e(this).after("<button type='button' class='wsu-person-remove dashicons dashicons-no'><span class='screen-reader-text'>Delete</span></button>")}),e.each(e("header .degree"),function(){e(this).after("<button type='button' class='wsu-person-remove dashicons dashicons-no'><span class='screen-reader-text'>Delete</span></button>")}),n.on("click",function(o){if(o.preventDefault(),o.target.disabled=!0,""!==i.val()){r.css("visibility","visible");var s={action:"wsu_people_get_data_by_nid",_ajax_nonce:t.wsuwp_people_edit_profile.nid_nonce,network_id:i.val(),request_from:t.wsuwp_people_edit_profile.request_from,is_refresh:e(o.target).is("#refresh-ad-data")?"true":"false"};e.post(t.ajaxurl,s,function(s){o.target.disabled=!1,r.css("visibility","hidden"),s.success?e.isEmptyObject(s.data)?t.alert("Sorry, a profile for "+i.val()+" could not be found."):(s.data.id?a.people.populate_person_from_people_directory(s.data):(e(".wsu-person").attr("data-nid",i.val()),e(".wsu-person .name").text(s.data.given_name+" "+s.data.surname),e("[name='post_title']").val(s.data.given_name+" "+s.data.surname),e(".wsu-person .title").text(s.data.title),e("[name='_wsuwp_profile_title[]']").val(s.data.title),e(".wsu-person .email").text(s.data.email),e("[name='_wsuwp_profile_alt_email']").val(s.data.email),e(".wsu-person .phone").text(s.data.telephone_number),e("[name='_wsuwp_profile_alt_phone']").val(s.data.telephone_number),e(".wsu-person .office").text(s.data.office),e("[name='_wsuwp_profile_alt_office']").val(s.data.office),e(".wsu-person .address").text(s.data.street_address),e("[name='_wsuwp_profile_alt_address']").val(s.data.street_address),l.val(s.data.confirm_ad_hash)),e("#wsuwp-university-taxonomies").addClass("show"),e("#wsuwp-profile-listing").addClass("show"),p.removeClass("profile-hide-button")):t.alert(s.data)})}else t.alert("Please enter a Network ID")}),p.on("click",function(o){o.preventDefault(),o.target.disabled=!0,r.css("visibility","visible"),e("#load-ad-data").addClass("profile-hide-button");var a={action:"wsu_people_confirm_nid_data",_ajax_nonce:t.wsuwp_people_edit_profile.nid_nonce,network_id:i.val(),confirm_ad_hash:l.val(),post_id:e("#post_ID").val(),request_from:t.wsuwp_people_edit_profile.request_from},s=e(".load-ad-container .description"),n=e("#publish");e.post(t.ajaxurl,a,function(t){t.success&&(i.attr("readonly",!0),s.html("The WSU Network ID used to populate this profile's data from "+s.data("location")+"."),e(".spinner").css("visibility","hidden"),p.addClass("profile-hide-button"),n.removeClass("profile-hide-button"))})}),d.on("focusout","[contenteditable='true']",function(){var t=e(this).attr("class"),o=e(this).index("."+t),a=e(this).text();e("[data-for='"+t+"']").eq(o).val(a)}),d.on("keypress","[contenteditable='true']",function(e){13===e.which&&e.preventDefault()}),d.on("click",".wsu-person-add-repeatable-meta",function(){e(this).before(c({type:e(this).data("type"),value:""}))}),d.on("focus",".title, .degree",function(){e(this).next("button:not(.wsu-person-add-repeatable-meta)").show(50)}),d.on("focusout",".title, .degree, .wsu-person-remove",function(t){var o=e(t.relatedTarget);if(!o.hasClass("wsu-person-remove"))if(o.hasClass("title")||o.hasClass("title")){var a=o.next(".wsu-person-remove").index(".wsu-person-remove");e(".wsu-person-remove").not(":eq("+a+")").hide(50)}else e(".wsu-person-remove").hide(50)}),d.on("click",".wsu-person-remove",function(){var t=e(this).prev("span"),o=t.attr("class"),a=t.index("."+o);t.remove(),e("[data-for='"+o+"']").eq(a).remove(),e(this).remove()}),d.on("click",".photo",function(){if(!e(this).hasClass("wsu-person-add-photo")){var t=e(this).offset();e("body").addClass("wsu-person-photo-collection-open"),u.css({top:t.top,left:t.left})}}),e(o).on("click",".wsu-person-photo-collection-close",function(t){t.target===this&&e("body").removeClass("wsu-person-photo-collection-open")}),e(o).on("click",".wsu-person-add-photo",function(){s?s.open():((s=t.wp.media({title:"Select or Upload Your Photos",multiple:!0,library:{type:"image",uploadedTo:t.wsuwp_people_edit_profile.post_id},button:{text:"Use photo(s)"}})).on("select",function(){var o=s.state().get("selection");e.each(o.models,function(o,s){var n=s.toJSON(),r=n.sizes.hasOwnProperty("thumbnail")?n.sizes.thumbnail.url:n.url,i=!1;-1===e.inArray(n.id,a.existing_photos())?(e("button.wsu-person-add-photo").before(f({src:r,id:n.id})),!i&&e(".photo").hasClass("wsu-person-add-photo")&&(e(".photo").removeClass("wsu-person-add-photo").prepend("<img src='"+r+"'>"),e(".photo figcaption").text("Manage photo collection"),i=!0)):t.alert(n.url+" is already in your collection.")})}),s.open())}),u.on("click",".wsu-person-remove",function(){e(this).parent(".wsu-person-photo-wrapper").remove()})}),e(".taxonomy-select2").select2({placeholder:"+ Add",closeOnSelect:!1,templateResult:function(t,o){return t.element&&e(o).addClass(e(t.element).attr("class")),t.text}}),a.existing_photos=function(){return e("[name='_wsuwp_profile_photos[]']").map(function(){return parseInt(e(this).val())}).get()}}(jQuery,window,document,wsuwp);